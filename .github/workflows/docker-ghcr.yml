name: Build and Push Docker Image to GHCR and Docker Hub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Grant necessary permissions for GHCR package management
permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate version tags
        id: version
        run: |
          DATE_TAG=$(date +'%Y-%m-%d')
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT
          
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          
          DATE_SHA_TAG="${DATE_TAG}-${SHORT_SHA}"
          echo "date_sha_tag=$DATE_SHA_TAG" >> $GITHUB_OUTPUT
          
          echo "Tags: latest, $DATE_TAG, $SHORT_SHA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image to both registries
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/shopping2go/gh-self-hosted-runner:latest
            ghcr.io/shopping2go/gh-self-hosted-runner:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gh-self-hosted-runner:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/gh-self-hosted-runner:${{ steps.version.outputs.date_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Display published tags
        run: |
          echo "✅ Published to GHCR: latest, ${{ github.sha }}"
          echo "✅ Published to Docker Hub: latest, ${{ steps.version.outputs.date_tag }}"

      - name: Make GHCR image public
        env:
          GH_TOKEN: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME="gh-self-hosted-runner"
          OWNER="shopping2go"
          
          if [ -z "${{ secrets.GHCR_PAT }}" ]; then
            echo "⚠️  No GHCR_PAT - using GITHUB_TOKEN (limited permissions)"
          fi
          
          sleep 10
          
          # Try to set visibility
          if gh api --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/orgs/$OWNER/packages/container/$PACKAGE_NAME" \
            -f visibility='public' 2>/dev/null || \
             gh api --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/users/$OWNER/packages/container/$PACKAGE_NAME" \
            -f visibility='public' 2>/dev/null; then
            echo "✅ Visibility set to public"
          fi
          
          sleep 3
          
          # Verify visibility
          CURRENT_VISIBILITY="unknown"
          if RESPONSE=$(gh api "/orgs/$OWNER/packages/container/$PACKAGE_NAME" 2>/dev/null); then
            CURRENT_VISIBILITY=$(echo "$RESPONSE" | jq -r '.visibility // "unknown"')
          elif RESPONSE=$(gh api "/users/$OWNER/packages/container/$PACKAGE_NAME" 2>/dev/null); then
            CURRENT_VISIBILITY=$(echo "$RESPONSE" | jq -r '.visibility // "unknown"')
          fi
          
          if [ "$CURRENT_VISIBILITY" = "public" ]; then
            echo "✅ Package is PUBLIC"
          else
            echo "❌ Package is PRIVATE - manual change required:"
            echo "   https://github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/settings"
          fi
