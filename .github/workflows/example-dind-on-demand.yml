# Example workflow demonstrating Docker-in-Docker (dind) on-demand usage
# Use this as a reference for workflows that need Docker commands on self-hosted runners
#
# This workflow shows two approaches:
# 1. Using docker/setup-docker action (recommended for compatibility)
# 2. Manual Docker installation and startup (alternative approach)

name: Example - Docker-in-Docker On-Demand

on:
  workflow_dispatch:
    inputs:
      approach:
        description: 'Docker setup approach'
        required: true
        default: 'action'
        type: choice
        options:
          - action
          - manual

jobs:
  # Approach 1: Using docker/setup-docker action (Recommended)
  docker-with-action:
    if: ${{ github.event.inputs.approach == 'action' }}
    runs-on: [self-hosted, docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker (on-demand)
        uses: docker/setup-docker@v3

      - name: Check Docker status
        run: |
          echo "ğŸ³ Verifying Docker is available..."
          docker info
          echo "âœ… Docker is ready!"

      - name: Run Docker commands
        run: |
          echo "ğŸ”§ Running example Docker commands..."
          docker run --rm hello-world
          echo "âœ… Docker-in-Docker is working!"

  # Approach 2: Manual Docker installation (Alternative)
  docker-manual:
    if: ${{ github.event.inputs.approach == 'manual' }}
    runs-on: [self-hosted, docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Docker is installed and running (on-demand)
        run: |
          echo "ğŸ³ Setting up Docker..."
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          echo "âœ… Docker service started!"

      - name: Check Docker status
        run: |
          echo "ğŸ³ Verifying Docker status..."
          docker info
          echo "âœ… Docker is ready!"

      - name: Run Docker commands
        run: |
          echo "ğŸ”§ Running example Docker commands..."
          docker run --rm hello-world
          echo "âœ… Docker-in-Docker is working!"

  # Example: Job that needs Docker for container builds
  # This job demonstrates a practical use case and runs independently
  # It uses the recommended action approach
  build-example:
    runs-on: [self-hosted, docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Add this step at the start of any job that needs Docker
      - name: Setup Docker (on-demand)
        uses: docker/setup-docker@v3

      - name: Build a test image
        run: |
          echo "ğŸ—ï¸ Building test image..."
          # Check if Dockerfile exists before building
          if [ -f Dockerfile ]; then
            docker build -t test-image:latest .
            echo "âœ… Image built successfully!"
          else
            echo "âš ï¸ No Dockerfile found, creating a simple test image..."
            echo "FROM alpine:latest" | docker build -t test-image:latest -
            echo "âœ… Test image created successfully!"
          fi

      - name: Verify the image
        run: |
          docker images | grep test-image
